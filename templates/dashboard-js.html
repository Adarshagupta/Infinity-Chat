<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const tabContents = document.querySelectorAll('.tab-content');

        sidebarItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const targetTab = this.getAttribute('data-tab');
                navigateToSection(targetTab);
            });
        });

        function navigateToSection(section) {
            sidebarItems.forEach(i => i.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            const activeItem = document.querySelector(`.sidebar-item[data-tab="${section}"]`);
            const activeContent = document.getElementById(section);

            if (activeItem && activeContent) {
                activeItem.classList.add('active');
                activeContent.classList.add('active');

                // Update the URL without reloading the page
                history.pushState(null, '', `/dashboard/${section}`);

                if (section === 'customer-support') {
                    initializeChat();
                } else if (section === 'api-analytics') {
                    loadAnalytics();
                } else if (section === 'fine-tuning') {
                    loadFineTuneJobs();
                } else if (section === 'plugins') {
                    loadPlugins();
                } else if (section === 'api-keys') {
                    loadApiKeys();  // Refresh API keys when visiting the api-keys section
                }
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function() {
            const section = window.location.pathname.split('/').pop();
            navigateToSection(section);
        });

        // Initial navigation based on current URL
        const initialSection = window.location.pathname.split('/').pop();
        navigateToSection(initialSection || 'api-keys');  // Default to 'api-keys' if no section in URL

        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = savedUser;
            updateUI();
            if (initialSection === 'api-keys' || !initialSection) {
                loadApiKeys();  // Load API keys only if the initial section is 'api-keys' or not specified
            }
        } else {
            currentUser = null;
            window.location.href = '/auth'; // Redirect to auth page if not logged in
        }

        // Add event listener for the refresh button
        const refreshButton = document.querySelector('button[onclick="refreshApiKeys()"]');
        if (refreshButton) {
            refreshButton.addEventListener('click', loadApiKeys);
        }
    });

    function loadApiKeys() {
        const loader = document.getElementById('loader');
        const apiKeysList = document.getElementById('apiKeysList');
        
        if (!loader || !apiKeysList) {
            console.error('Loader or API keys list element not found');
            return;
        }

        loader.classList.remove('hidden');
        apiKeysList.innerHTML = '<p class="text-gray-500">Loading API keys...</p>';

        fetch('/dashboard/home/user/api_keys')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                apiKeysList.innerHTML = '';

                if (!data.api_keys || data.api_keys.length === 0) {
                    apiKeysList.innerHTML = '<p class="text-gray-500">No API keys found.</p>';
                    return;
                }

                data.api_keys.forEach(key => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-100 rounded-md p-4 mb-4 flex justify-between items-center transition-transform duration-200 hover:bg-white hover:scale-105';
                    li.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-2">${key.key}</span>
                            <button onclick="copyToClipboard('${key.key}')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                        <div>
                            <button onclick="openApiTestModal('${key.key}')" class="bg-blue-500 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-600 transition duration-300 mr-2">Test</button>
                            <button onclick="deleteApiKey('${key.id}')" class="bg-red-500 text-white px-4 py-2 rounded-md font-medium hover:bg-red-600 transition duration-300">Delete</button>
                        </div>
                    `;
                    apiKeysList.appendChild(li);
                });

                showNotification('API keys loaded successfully');
            })
            .catch(error => {
                console.error('Error loading API keys:', error);
                apiKeysList.innerHTML = `<p class="text-red-500">Error loading API keys: ${error.message}</p>`;
                showNotification('Error loading API keys: ' + error.message, 'error');
            })
            .finally(() => {
                loader.classList.add('hidden');
            });
    }

    // Replace the existing refreshApiKeys function with this:
    function refreshApiKeys() {
        loadApiKeys();
    }

    // Add logout functionality
    const logoutLink = document.getElementById('logoutLink');
    logoutLink.addEventListener('click', function(e) {
        e.preventDefault();
        // Send a POST request to the logout endpoint
        fetch('/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Logged out successfully") {
                // Redirect to the home page or login page after successful logout
                window.location.href = '/';
            } else {
                console.error('Logout failed:', data.error);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });

    function testApiKey(apiKey) {
        fetch('/test_api_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `api_key=${apiKey}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification(`API test successful! Response: ${JSON.stringify(data.response)}`);
            } else {
                showNotification(`API test failed: ${data.error}`, 'error');
            }
        })
        .catch((error) => {
            showNotification(`Error: ${error}`, 'error');
        });
    }

    function openApiTestModal(apiKey) {
        document.getElementById('apiTestModal').style.display = 'block';
        document.getElementById('apiKeyInput').value = apiKey;
    }

    function closeApiTestModal() {
        document.getElementById('apiTestModal').style.display = 'none';
        document.getElementById('apiResponse').innerHTML = '';
    }

    async function sendApiTest() {
        const apiKey = document.getElementById('apiKeyInput').value;
        const endpoint = document.getElementById('endpointSelect').value;
        const method = document.getElementById('methodSelect').value;
        const headers = JSON.parse(document.getElementById('headersInput').value || '{}');
        const body = document.getElementById('apiInputText').value;

        // Add the API key to the headers
        headers['Authorization'] = `Bearer ${apiKey}`;

        const responseDiv = document.getElementById('apiResponse');
        responseDiv.innerHTML = 'Sending request...';

        try {
            console.log('Request URL:', endpoint);
            console.log('Request Method:', method);
            console.log('Request Headers:', headers);
            console.log('Request Body:', body);

            const response = await fetch(endpoint, {
                method: method,
                headers: headers,
                body: method === 'POST' ? body : undefined
            });

            console.log('Response Status:', response.status, response.statusText);
            console.log('Response Headers:', Object.fromEntries(response.headers));

            const statusLine = `Status: ${response.status} ${response.statusText}\n\n`;
            
            let headerText = 'Headers:\n';
            for (let [key, value] of response.headers) {
                headerText += `${key}: ${value}\n`;
            }
            headerText += '\n';

            const responseText = await response.text();

            const formattedResponse = `${statusLine}${headerText}Response Body:\n${responseText}`;
            responseDiv.innerHTML = `<pre>${escapeHtml(formattedResponse)}</pre>`;
        } catch (error) {
            console.error('Fetch Error:', error);
            responseDiv.innerHTML = `Error: ${escapeHtml(error.message)}`;
        }
    }

    // Helper function to escape HTML special characters
    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    let chatInitialized = false;

    function initializeChat() {
        if (!chatInitialized) {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div class="mb-2"><strong>Chatbot:</strong> Hello! How can I assist you today?</div>';
            chatInitialized = true;
        }
    }

    function sendMessage() {
        const userInput = document.getElementById('user-input');
        const message = userInput.value.trim();
        if (message) {
            appendMessage('You', message);
            userInput.value = '';
            
            // Simulate chatbot response (replace this with actual API call in production)
            setTimeout(() => {
                const response = "Thank you for your message. Our support team will get back to you shortly.";
                appendMessage('Chatbot', response);
            }, 1000);
        }
    }

    function appendMessage(sender, message) {
        const chatContainer = document.getElementById('chat-container');
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
        messageElement.classList.add('mb-2');
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function loadAnalytics() {
        fetch('/api/analytics')
            .then(response => response.json())
            .then(data => {
                displayAnalyticsChart(data);
                displayAnalyticsTable(data);
            })
            .catch(error => console.error('Error fetching analytics:', error));
    }

    function displayAnalyticsChart(data) {
        const ctx = document.getElementById('apiUsageChart').getContext('2d');
        
        // Process data for the chart
        const apiCalls = {};
        const responseTimes = {};
        const statusCodes = {};
        
        data.forEach(item => {
            const date = new Date(item.timestamp).toLocaleDateString();
            apiCalls[date] = (apiCalls[date] || 0) + 1;
            responseTimes[date] = (responseTimes[date] || 0) + item.response_time;
            statusCodes[date] = statusCodes[date] || {};
            statusCodes[date][item.status_code] = (statusCodes[date][item.status_code] || 0) + 1;
        });

        // Sort dates and get the last 14 days
        const sortedDates = Object.keys(apiCalls).sort((a, b) => new Date(a) - new Date(b));
        const last14Days = sortedDates.slice(-14);

        // Prepare data for the chart
        const chartData = {
            labels: last14Days,
            datasets: [
                {
                    label: 'API Calls',
                    data: last14Days.map(date => apiCalls[date] || 0),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    yAxisID: 'y',
                    fill: true
                },
                {
                    label: 'Avg Response Time (ms)',
                    data: last14Days.map(date => apiCalls[date] ? (responseTimes[date] / apiCalls[date]) * 1000 : 0),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'y1',
                    fill: true
                }
            ]
        };

        // Clear previous chart if it exists
        Chart.getChart(ctx)?.destroy();

        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'API Usage Analytics'
                    },
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                const date = context[0].label;
                                const statusCodesForDay = statusCodes[date];
                                if (!statusCodesForDay) return '';
                                
                                let statusText = '\nStatus Codes:';
                                for (let code in statusCodesForDay) {
                                    statusText += `\n${code}: ${statusCodesForDay[code]}`;
                                }
                                return statusText;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Number of API Calls'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Avg Response Time (ms)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
    }

    function displayAnalyticsTable(data) {
        const tableBody = document.getElementById('analytics-table-body');
        tableBody.innerHTML = '';

        data.slice(0, 10).forEach(item => {
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = item.api_key;
            row.insertCell(1).textContent = item.endpoint;
            row.insertCell(2).textContent = new Date(item.timestamp).toLocaleString();
            row.insertCell(3).textContent = (item.response_time * 1000).toFixed(2);
            row.insertCell(4).textContent = item.status_code;
        });
    }

    function integrateWhatsApp() {
        // Implement WhatsApp integration logic here
        showNotification('WhatsApp integration coming soon!');
    }

    function integrateTelegram() {
        // Implement Telegram integration logic here
        showNotification('Telegram integration coming soon!');
    }

    function integrateSlack() {
        // Implement Slack integration logic here
        showNotification('Slack integration coming soon!');
    }

    function integrateDiscord() {
        // Implement Discord integration logic here
        showNotification('Discord integration coming soon!');
    }
    let currentUser = null;
let currentApiKey = null;
let currentLLM = null;

async function processUrl() {
    const url = document.getElementById('urlInput').value;
    const llm = document.getElementById('llmSelect').value;
    const resultDiv = document.getElementById('result');
    const apiKeyResultDiv = document.getElementById('apiKeyResult');
    const integrationCodeTextarea = document.getElementById('integration-code');
    const loader = document.getElementById('loader');
    const loaderText = loader.querySelector('p');

    loader.classList.remove('hidden');

    const steps = [
        'Fetching data...',
        'Training LLM...',
        'Generating API...'
    ];

    try {
        for (const step of steps) {
            loaderText.textContent = step;
            await new Promise(resolve => setTimeout(resolve, 5000));
        }

        const response = await axios.post('/dashboard/home/process_url', { url: url, llm: llm });
        console.log('Full API response:', response.data);

        resultDiv.classList.remove('hidden');
        apiKeyResultDiv.innerHTML = `
            <p class="mb-2">Your API Key: <span class="font-mono bg-gray-100 px-2 py-1 rounded">${response.data.api_key}</span></p>
            <p class="mb-2">Selected LLM: <span class="font-mono bg-gray-100 px-2 py-1 rounded">${response.data.llm}</span></p>
        `;

        if (response.data.integration_code) {
            integrationCodeTextarea.value = response.data.integration_code;
        } else {
            integrationCodeTextarea.value = 'Integration code not found in response';
        }

        await fetchApiKeys();
        showNotification('URL processed successfully');
    } catch (error) {
        console.error('Error:', error);
        let errorMessage = 'An unknown error occurred';
        if (error.response) {
            errorMessage = error.response.data.error || 'Server error';
        } else if (error.request) {
            errorMessage = 'No response received from the server. Please check your internet connection.';
        } else {
            errorMessage = error.message;
        }
        resultDiv.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
        showNotification(errorMessage, 'error');
    } finally {
        loader.classList.add('hidden');
        loaderText.textContent = 'Processing...';
    }
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const content = document.getElementById('notification-content');
    
    if (!notification || !content) {
        console.error('Notification elements not found');
        return;
    }

    const icon = notification.querySelector('svg');

    content.textContent = message;

    // Change icon and color based on type
    if (type === 'error') {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />';
        icon.classList.remove('text-green-400');
        icon.classList.add('text-red-400');
    } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />';
        icon.classList.remove('text-red-400');
        icon.classList.add('text-green-400');
    }

    notification.style.display = 'block';

    // Hide the notification after 5 seconds
    setTimeout(() => {
        closeNotification();
    }, 5000);
}

function closeNotification() {
    const notification = document.getElementById('notification');
    notification.style.display = 'none';
}

function copyToClipboard(text) {
    const tempInput = document.createElement('input');
    tempInput.value = text;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showNotification('API key copied to clipboard');
}

function addApiKeyButtons() {
    const buttonContainer = document.getElementById('apiKeyButtonContainer');
    buttonContainer.innerHTML = '';
    buttonContainer.className = 'mt-2 flex justify-between';
    buttonContainer.innerHTML = `
        <button onclick="copySelectedApiKey()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300">Copy</button>
        <button onclick="deleteSelectedApiKey()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-300">Delete</button>
    `;
}

async function deleteSelectedApiKey() {
    const dropdown = document.getElementById('apiKeyDropdown');
    const selectedApiKey = dropdown.value;
    if (!selectedApiKey) {
        showNotification('Please select an API key to delete', 'error');
        return;
    }
    await deleteApiKey(selectedApiKey);
    await fetchApiKeys();
}

async function deleteApiKey(apiKeyId) {
    const loader = document.getElementById('loader');
    loader.classList.remove('hidden');
    try {
        const response = await fetch('/dashboard/home/delete_api_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ api_key_id: apiKeyId }),
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        showNotification(data.message);
        loadApiKeys();  // Refresh the API keys list
    } catch (error) {
        console.error('Error deleting API key:', error);
        showNotification('Error deleting API key: ' + error.message, 'error');
    } finally {
        loader.classList.add('hidden');
    }
}

function updateUI() {
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');

    if (currentUser) {
        userInfo.classList.remove('hidden');
        userEmail.textContent = currentUser;
    } else {
        userInfo.classList.add('hidden');
    }
}
function showTab(tabId) {
    navigateToSection(tabId);
}
function refreshApiKeys() {
    const loader = document.getElementById('loader');
    loader.classList.remove('hidden');

    fetch('/user/api_keys')
        .then(response => response.json())
        .then(data => {
            const apiKeysList = document.getElementById('apiKeysList');
            apiKeysList.innerHTML = '';

            data.api_keys.forEach(key => {
                const li = document.createElement('li');
                li.className = 'bg-gray-100 rounded-md p-4 mb-4 flex justify-between items-center transition-transform duration-200 hover:bg-white hover:scale-105';
                li.innerHTML = `
                    <span>${key.key}</span>
                    <div>
                        <button onclick="openApiTestModal('${key.key}')" class="bg-blue-500 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-600 transition duration-300 mr-2">Test</button>
                        <form action="/delete_api_key" method="post" class="inline">
                            <input type="hidden" name="api_key_id" value="${key.id}">
                            <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded-md font-medium hover:bg-purple-600 transition duration-300">Delete</button>
                        </form>
                    </div>
                `;
                apiKeysList.appendChild(li);
            });

            showNotification('API keys refreshed successfully');
        })
        .catch(error => {
            console.error('Error refreshing API keys:', error);
            showNotification('Error refreshing API keys', 'error');
        })
        .finally(() => {
            loader.classList.add('hidden');
        });
}
function logout() {
fetch('/logout', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
})
.then(response => response.json())
.then(data => {
    if (data.message === "Logged out successfully") {
        // Clear any user-related data from local storage
        localStorage.removeItem('currentUser');
        // Redirect to the login page or home page
        window.location.href = '/auth';
    } else {
        console.error('Logout failed:', data.error);
        showNotification('Logout failed', 'error');
    }
})
.catch((error) => {
    console.error('Error:', error);
    showNotification('An error occurred during logout', 'error');
});
}
       // Initialize Shepherd.js
       const tour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                classes: 'shadow-md bg-purple-500',
                scrollTo: { behavior: 'smooth', block: 'center' }
            }
        });

        // Define the steps
        tour.addStep({
            id: 'step-1',
            text: 'Welcome to the Dashboard! This is your main control center.',
            attachTo: { element: '.main-content h1', on: 'bottom' },
            buttons: [
                {
                    text: 'Next',
                    action: tour.next
                }
            ]
        });

        tour.addStep({
            id: 'step-2',
            text: 'Use the sidebar to navigate between different sections.',
            attachTo: { element: '.sidebar', on: 'right' },
            buttons: [
                {
                    text: 'Back',
                    action: tour.back
                },
                {
                    text: 'Next',
                    action: tour.next
                }
            ]
        });

        tour.addStep({
            id: 'step-3',
            text: 'Here you can manage your API keys.',
            attachTo: { element: '#api-keys', on: 'top' },
            buttons: [
                {
                    text: 'Back',
                    action: tour.back
                },
                {
                    text: 'Next',
                    action: tour.next
                }
            ]
        });

        tour.addStep({
            id: 'step-4',
            text: 'Create new chatbots using the Chatbot Creator.',
            attachTo: { element: '#chatbot-creator', on: 'top' },
            buttons: [
                {
                    text: 'Back',
                    action: tour.back
                },
                {
                    text: 'Next',
                    action: tour.next
                }
            ]
        });

        tour.addStep({
            id: 'step-5',
            text: 'Manage your profile and settings here.',
            attachTo: { element: '#profile', on: 'top' },
            buttons: [
                {
                    text: 'Back',
                    action: tour.back
                },
                {
                    text: 'Finish',
                    action: tour.complete
                }
            ]
        });

        // Start the tour
        tour.start();

function loadPlugins() {
    const pluginList = document.getElementById('plugin-list');
    pluginList.innerHTML = ''; // Clear existing plugins

    const plugins = [
        {
            id: 'webhook-integration',
            name: 'Webhook Integration',
            description: 'Set up webhooks for real-time notifications of chatbot events.',
            installed: false
        },
        // Add more plugins here
    ];

    plugins.forEach(plugin => {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg shadow-md';
        card.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">${plugin.name}</h3>
            <p class="text-gray-600 mb-4">${plugin.description}</p>
            <button onclick="togglePlugin('${plugin.id}')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300">
                ${plugin.installed ? 'Uninstall' : 'Install'}
            </button>
        `;
        pluginList.appendChild(card);
    });
}

function togglePlugin(pluginId) {
    if (pluginId === 'webhook-integration') {
        openWebhookModal();
    } else {
        console.log(`Toggling plugin: ${pluginId}`);
        showNotification(`Plugin ${pluginId} has been toggled. This is a placeholder action.`);
    }
    loadPlugins(); // Reload plugins to update UI
}

// Add these functions to the existing script
function openWebhookModal() {
    document.getElementById('webhookModal').style.display = 'block';
}

function closeWebhookModal() {
    document.getElementById('webhookModal').style.display = 'none';
}

function setupWebhook() {
    const webhookUrl = document.getElementById('webhookUrl').value;
    
    fetch('/api/setup_webhook', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ webhook_url: webhookUrl }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message);
            closeWebhookModal();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while setting up the webhook', 'error');
    });
}

function loadTeams() {
    fetch('/api/teams')
        .then(response => response.json())
        .then(teams => {
            const teamList = document.getElementById('team-list');
            teamList.innerHTML = '';
            if (teams.length === 0) {
                teamList.innerHTML = '<li class="py-4 text-gray-500">No teams found. Create a team to get started!</li>';
            } else {
                teams.forEach(team => {
                    const li = document.createElement('li');
                    li.className = 'py-4';
                    li.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold">${team.name}</h4>
                                <p class="text-sm text-gray-500">Role: ${team.role}</p>
                            </div>
                            <button onclick="showTeamMembers(${team.id})" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300">
                                View Members
                            </button>
                        </div>
                    `;
                    teamList.appendChild(li);
                });
            }
        })
        .catch(error => {
            console.error('Error loading teams:', error);
            showNotification('Error loading teams. Please try again.', 'error');
        });
}

function createTeam(event) {
    event.preventDefault();
    const teamName = document.getElementById('team-name').value;
    console.log('Creating team with name:', teamName); // Debug log
    fetch('/api/teams', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: teamName }),
    })
    .then(response => {
        console.log('Response status:', response.status); // Debug log
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data); // Debug log
        if (data.message) {
            showNotification(data.message);
            document.getElementById('team-name').value = '';  // Clear the input field
            loadTeams();  // Reload the team list
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating team:', error);
        showNotification('An error occurred while creating the team', 'error');
    });
}

function showTeamMembers(teamId) {
    fetch(`/api/teams/${teamId}/members`)
        .then(response => response.json())
        .then(members => {
            const memberList = members.map(member => `
                <li class="py-2">
                    <p class="text-sm">${member.email} (${member.role})</p>
                </li>
            `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-semibold mb-4">Team Members</h3>
                    <ul class="divide-y divide-gray-200">
                        ${memberList}
                    </ul>
                    <div class="mt-4">
                        <input type="email" id="invite-email" placeholder="Enter email to invite" class="w-full px-3 py-2 border rounded-md">
                        <button onclick="inviteTeamMember(${teamId})" class="mt-2 w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-300">
                            Invite Member
                        </button>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition duration-300">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        })
        .catch(error => console.error('Error loading team members:', error));
}

function inviteTeamMember(teamId) {
    const email = document.getElementById('invite-email').value;
    fetch(`/api/teams/${teamId}/invite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showNotification(data.message);
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error inviting team member:', error);
        showNotification('An error occurred while inviting the team member', 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // ... (existing code)

    // Add event listener for create team form
    document.getElementById('create-team-form').addEventListener('submit', createTeam);

    // Add a new sidebar item for team management
    const sidebarMenu = document.querySelector('.sidebar-menu');
    const teamManagementItem = document.createElement('a');
    teamManagementItem.href = '#';
    teamManagementItem.className = 'sidebar-item';
    teamManagementItem.setAttribute('data-tab', 'team-management');
    teamManagementItem.innerHTML = `
        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <span class="sidebar-text">Team Management</span>
        <span class="sidebar-tooltip">Team Management</span>
    `;
    sidebarMenu.appendChild(teamManagementItem);

    // Load teams when the team management tab is clicked
    teamManagementItem.addEventListener('click', function() {
        showTab('team-management');
        loadTeams();
    });

    const createTeamForm = document.getElementById('create-team-form');
    if (createTeamForm) {
        createTeamForm.addEventListener('submit', createTeam);
        console.log('Create team form listener added'); // Debug log
    } else {
        console.error('Create team form not found'); // Debug log
    }
});

window.chatWithAI = async function(input) {
    try {
        const response = await fetch('https://infin8t.onrender.com/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                input: input,
                api_key: '{api_key}'
            })
        });
        const data = await response.json();
        
        // Check for follow-up messages
        if (data.follow_up) {
            setTimeout(() => {
                addMessage('AI', data.follow_up);
                playSound('message-received-sound');
            }, data.follow_up_delay * 60 * 1000);
        }
        
        return data;
    } catch (error) {
        console.error('Error:', error);
        return {error: `Error: ${error.message || 'Unknown error occurred'}`};
    }
};

function fetchApiKeys() {
    fetch('/dashboard/home/user/api_keys')
        .then(response => response.json())
        .then(data => {
            const apiKeysList = document.getElementById('apiKeysList');
            apiKeysList.innerHTML = '';
            data.api_keys.forEach(key => {
                const li = document.createElement('li');
                li.textContent = `API Key: ${key.key} (LLM: ${key.llm})`;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteApiKey(key.id);
                li.appendChild(deleteButton);
                apiKeysList.appendChild(li);
            });
        })
        .catch(error => console.error('Error fetching API keys:', error));
}

// ... (existing code)

function createApiKey() {
    const url = document.getElementById('websiteUrl');
    const llm = document.getElementById('llmChoice');
    
    if (!url || !llm) {
        console.error('Website URL or LLM choice elements not found');
        return;
    }

    fetch('/dashboard/home/process_url', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: url.value, llm: llm.value }),
    })
    .then(response => response.json())
    .then(data => {
        showNotification(`API Key created: ${data.api_key}`);
        const integrationCode = document.getElementById('integrationCode');
        if (integrationCode) {
            integrationCode.value = data.integration_code;
        }
        loadApiKeys(); // Refresh the API keys list
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while creating the API key.', 'error');
    });
}

// ... (existing code)

// Call loadApiKeys when the page loads
document.addEventListener('DOMContentLoaded', loadApiKeys);
</script>